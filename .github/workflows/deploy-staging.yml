name: Deploy to Railway Staging

on:
  push:
    branches:
      - development
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    name: Deploy to Railway Staging
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸš€ Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: arbitra-api-staging
          
      - name: â³ Wait for deployment
        run: sleep 30
        
      - name: ðŸ§ª Run health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://arbitra-api-staging.up.railway.app/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Health check passed (Status: $response)"
          else
            echo "âŒ Health check failed (Status: $response)"
            exit 1
          fi
          
      - name: ðŸ“Š Deployment summary
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: development" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: arbitra-api-staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://arbitra-api-staging.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Staging deployment successful!" >> $GITHUB_STEP_SUMMARY
